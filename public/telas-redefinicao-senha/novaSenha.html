<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/novaSenha.css">
    <link rel="shortcut icon" href="../assets/Tree Technology (Logo fundo transparente + nome).png" type="image/x-icon">
    <title>Redefinir senha | Tree Technology</title>
</head>

<body>
    <div>
        <a href="redefinir.html"><img id="seta" src="../assets/seta.jpg"></a>
    </div>
    <main>
        <div class="div_branca">
            <span>REDEFINIR SENHA</span>
            <div id="input-token">
                <label>Digite o token enviado por e-mail:</label>
                <input type="text" id="token" placeholder="Token" maxlength="6">
            </div>
            <div id="input-token" style="position: relative;">
                <label>Digite a nova senha:</label>
                <input id="inp_senha" placeholder="Nova senha" type="password" maxlength="16">
                <img id="olho" onclick="visualizarSenha()" src="../assets/olhoAberto.png" class="toggle-password">
            </div>
            <div id="input-token" style="position: relative;">
                <label>Confirme a nova senha:</label>
                <input id="inp_senha2" placeholder="Confirmar senha" type="password" maxlength="16">
                <img id="olho2" onclick="visualizarSenha2()" src="../assets/olhoAberto.png" class="toggle-password">
            </div>
            <button onclick="verificarToken()" id="botao-redefinir">Confirmar</button>
        </div>
    </main>
</body>

<script>
    async function verificarToken() {
        const tokenInput = document.querySelector('#token').value;

        const response = await fetch('/novaSenha', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ token: tokenInput }),
        });

        const message = await response.text();
        alert(message);

        if (message == "Token verificado com sucesso!") {
            validarSenha();
        }
    }

    function validarSenha() {
        var senha = document.querySelector("#inp_senha");
        var senha2 = document.querySelector("#inp_senha2");
        var mensagem = document.querySelector("#mensagem");

        if (senha.value != senha2.value) {
            alert("As senhas n√£o correspondem.");
            
            return false;
        } else if (
            senha.value.length < 8 || senha.value.length > 16 || 
            senha2.value.length < 8 || senha2.value.length > 16) {
                
            alert("A senha deve ter entre 8 e 16 caracteres.");
            return false;
        } else {
            alterarSenha();
        }

    }

    function alterarSenha() {
        var senha = document.querySelector("#inp_senha").value;
        var email = sessionStorage.EMAIL_INPUT;

        fetch(`/empresa/alterarSenha/${senha}/${email}`, { cache: "no-store" })
        .then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        alert('Senha alterada com sucesso!!')
                        window.location = "/telas-redefinicao-senha/novaSenha.html";                   
                    })
                } else {
                    alert('Houve um erro ao tentar alterar a senha!')
                }
            })
    }

    function visualizarSenha() {
        let inputSenha = document.getElementById("inp_senha")
        let imgSenha = document.getElementById("olho")
        if (inputSenha.type == "password") {
            imgSenha.src = "../assets/olhoFechado.png"
            inputSenha.type = 'text'
        } else {
            imgSenha.src = "../assets/olhoAberto.png"
            inputSenha.type = 'password'
        }
    }

    function visualizarSenha2() {
        let inputSenha2 = document.getElementById("inp_senha2")
        let imgSenha2 = document.getElementById("olho2")
        if (inputSenha2.type == "password") {
            imgSenha2.src = "../assets/olhoFechado.png"
            inputSenha2.type = 'text'
        } else {
            imgSenha2.src = "../assets/olhoAberto.png"
            inputSenha2.type = 'password'
        }
    }

</script>

</html>